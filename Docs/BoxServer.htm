<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>BoxServer 说明文档</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
<!--
p {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-style: normal;
	font-weight: normal;
	font-variant: normal;
}
a {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-style: normal;
	font-weight: bold;
	font-variant: normal;
	cursor: hand;
}
body {
	font-family: Verdana, Arial, Helvetica, sans-serif;
	font-size: 10px;
	font-weight: normal;
}
.style1 {
	font-size: 12px;
	font-weight: bold;
}
-->
</style>
</head>
<body>
<h3>BoxServer 说明文档</h3>
<p>更新于: 2004年3月1日<br>
  BoxServer 版本: 1.0</p>
<p><strong>目录</strong></p>
<ol>
  <li>BoxServer: 基本信息</li>
  <li>安装</li>
  <li>配置</li>
  <li>稳定性</li>
  <li>安全性</li>
  <li>身份验证</li>
  <li>生成器</li>
  <li>模块
    <ol>
      <li>核心</li>
      <li>构建器</li>
      <li>检索数据文件</li>
      <li>脚本浏览器</li>
      <li>生成组</li>
      <li>客户端列表</li>
    </ol>
  </li>
  <li>卸载</li>
  <li>支持</li>
</ol>
<p class="style1">1. BoxServer: 基本信息</p>
<p>BoxServer是一套用于RunUO的脚本集合，允许Pandora's Box访问附加功能。有关完整的功能列表，请查看第7节：模块。</p>
<p>本文档提供了关于运行BoxServer的重要信息，包括其安全性和功能。请在安装服务器扩展之前花几分钟时间阅读。</p>
<p>BoxServer随Pandora's Box 2.0一起推出，基于.NET remoting架构，这是一种用于跨域通信的架构。简单来说，BoxServer在RunUO服务器上创建一个特殊类型的BoxRemote对象，并注册该对象以供远程访问。BoxRemote对象位于名为BoxServer.dll的库中，该库安装在您的\RunUO\文件夹中。这是必要的，因为.NET remoting通过对象的类型和程序集来识别远程对象。远程对象有一个名为PerformRemoteRequest()的公共方法，允许Pandora's Box向服务器发送和处理消息（或数据包）。</p>
<p>基本事务机制如下：</p>
<ol>
  <li>Pandora创建一个消息（任何继承自BoxMessage的对象）并使用ZLib将其压缩为字节流。</li>
  <li>Pandora连接到远程服务器并调用已注册BoxRemote对象上的PerformRemoteRequest方法，将数据流作为参数传递给该方法。</li>
  <li>服务器解压缩数据包，执行身份验证，如果成功，则执行请求的操作。</li>
  <li>如果处理过程的结果是错误，或者如果操作需要从服务器发送回Pandora的数据，服务器也会创建消息，使用ZLib压缩并通过ZLib发送回来。</li>
</ol>
<p class="style1">2. 安装</p>
<p>安装通过向导执行，将执行以下操作：</p>
<ol>
  <li>将BoxServer.dll复制到您的\RunUO\文件夹</li>
  <li>更新您的\RunUO\Data\Assemblies.cfg文件，确保BoxServer.dll和System.Runtime.Remoting.dll库由RunUO加载。</li>
  <li>将所有脚本复制到目标文件夹。您可以选择要安装的模块。</li>
</ol>
<p class="style1">3. 配置</p>
<p>BoxServer的配置位于BoxServer安装文件夹中的Configuration.cs文件中。您可以配置以下属性：</p>
<ul>
  <li>端口：BoxServer需要主机机器上的未使用端口。默认情况下，此值为8035，但如果您的系统上已使用此端口，您可能需要更改它。如果是这种情况，您将在RunUO控制台中收到一条错误消息，说明BoxServer端口已被使用。</li>
  <li>消息色调：这允许您为BoxServer脚本在游戏中生成的所有消息指定色调。</li>
  <li>最低访问级别：指定访问BoxServer功能所需的最低AccessLevel。这可以为特定功能覆盖：查看第6节：身份验证了解更多详细信息。</li>
</ul>
<p class="style1">4. 稳定性</p>
<p>组成BoxServer的脚本已经过测试，被认为是稳定的。.NET Remoting本身提供了额外的稳定性，因为在大多数情况下，BoxServer代码中的错误会发送到Pandora's Box客户端，而不是RunUO进程。但这并不总是发生，以下是过程的简要描述及其含义。</p>
<ol>
  <li>Pandora's Box在BoxServer上执行操作。这包括身份验证，然后是正在处理的消息的Perform()方法。在此范围内发生的任何事情都由Pandora's Box管理，因此如果此代码导致异常，此异常将不会使服务器崩溃。</li>
  <li>在某些情况下，Perform()方法将与用户交互。例如，当放置生成组时，它将为调用客户端分配特殊目标。这是分离发生的地方：目标分配后发生的任何事情都由服务器管理，因此如果此代码（即OnTarget()）导致异常，它将使服务器崩溃。已经投入大量精力来评估此类情况，以确保最大可能的稳定性。</li>
</ol>
<p class="style1">5. 安全性</p>
<p><strong>5.1 账户信息安全</strong></p>
<p>账户信息由Pandora's Box用于在BoxServer上验证用户身份。BoxServer自然通过Server.Accounting.Accounts类访问此信息。Pandora's Box将从用户收集此信息。账户名称将以纯文本形式存储在Pandora's Box配置文件中，而密码将使用MD5哈希进行哈希处理。</p>
<p>Pandora's Box永远不会在文件中或永久在内存中以纯文本形式存储密码。相反，一旦用户提供了密码，它将执行哈希处理。哈希过程意味着原始字符串数据的丢失，这使得任何人几乎不可能将哈希还原为原始字符串。此外，即使没有证明，人们强烈认为没有两个不同的字符串可以导致相同的哈希。换句话说，无法从Pandora's Box检索账户密码。</p>
<p>在服务器上，身份验证是通过计算Accounts类中存储的密码上的哈希来执行的。如果两个哈希匹配，身份验证成功。</p>
<p><strong>5.2 网络安全</strong></p>
<p>.NET remoting在主机机器上公开一个对象。任何可以连接到远程服务的人都可以实例化此对象。名为BoxRemote的对象以单例模式工作，这意味着只会创建一个对象，它将为来自外部客户端的所有远程请求提供服务。客户端只能调用对象上定义的一个方法，PerformRemoteRequest()，它接受类型名称和字节流作为参数。服务器将尝试找到与提供的参数对应的已加载类型：如果未找到，它将返回FeatureNotSupported消息，否则它将尝试解压缩和反序列化数据。如果此过程成功，它将按照位于服务器本身上的消息类的描述对消息执行身份验证。这允许服务器管理员严格控制对BoxServer功能的访问，使架构尽可能安全。</p>
<p>注意：架构依赖于您对员工的信任。如果您不完全信任您的员工，请限制他们对BoxServer的访问或将最低AccessLevel设置为Administrator或Seer（默认情况下是GameMaster）。虽然默认的BoxServer安装不包含任何潜在的危险情况，但如果使用不当，可能会导致令人讨厌的情况（想想在Britain上创建的巨大屋顶）。在配置脚本浏览器时应特别小心，请查看相应部分了解详细信息。</p>
<p class="style1">6. 身份验证</p>
<p>服务器上安装的每个功能都有两种级别的身份验证：</p>
<ol>
  <li>基本身份验证：这是默认情况下在服务器本身中构建的。始终执行用户名和密码的身份验证，如安全性部分所述，不应移除。还有最低AccessLevel，用于访问服务器，此值不应设置为Player，否则您的服务器上的任何用户都可以使用某些功能。</li>
  <li>高级身份验证：这是通过在单个消息（或功能）上实现IAuthenticable接口来完成的。IAuthenticable接口定义如下：
    <ul>
      <li>AccessLevel <strong>MinAccessLevel</strong> { get; } : 覆盖访问此功能所需的最低AccessLevel。请记住，此值不能低于全局最低AccessLevel，因为此检查始终首先执行。</li>
      <li>bool <strong>RequireOnlineMobile</strong> { get; } : 指定使用此功能时用户是否必须实际在线。例如，创建生成组：用户必须登录服务器才能定位生成器的位置。</li>
    </ul>
  </li>
</ol>
  <p>实现IAuthenticable接口非常简单，可以对任何继承自BoxMessage的类进行（对其他类来说意义不大）。如果实现正确，服务器将自动执行接口暗示的检查。您可以在Modules\SpawnGroups\SpawnMessage.cs中看到此实现的示例。</p>
  <p class="style1">7. 生成器</p>
  <p>BoxServer在两个模块中处理生成器对象：</p>
  <ol>
    <li>SpawnData数据文件：用于在Pandora's Box旅行地图上显示现有生成器。生成器评估每个生成器对象并将其转换为在Pandora's Box中使用的SpawnEntry对象。</li>
    <li>生成组模块：顾名思义，此模块将Pandora's Box中定义的生成组转换为实际生成。</li>
  </ol>
  <p>这两种操作都需要了解服务器特定的生成器对象。当前的安装向导支持默认生成器和XmlSpawner，为用户提供设计用于与这些对象正确工作的代码。</p>
  <p>所有生成器特定代码都位于Core\SpawnerHelper.cs文件中。如果您使用的生成器不受BoxServer默认支持，您可以选择向导中的'其他'选项并自行填写方法。SpawnerHelper类包含三个静态方法和一个属性：</p>
  <ol>
    <li>public static Type <strong>SpawnerType</strong> { get; } : 定义用于生成器的对象类型。这用于在生成SpawnData数据文件时识别作为生成器起作用的对象。</li>
    <li>public static SpawnEntry <strong>SpawnerToData</strong>( Item spawnerItem ) : 此方法将生成器物品转换为SpawnEntry对象，其中包含生成信息（位置等）。这用于构建SpawnData。</li>
    <li>public static Item <strong>CreateBoxSpawn</strong>( BoxSpawn spawn ) : 此方法将BoxSpawn对象转换为填充有将生成生物的生成器对象。此方法返回的生成器对象不应处于活动状态。</li>
    <li>public static void <strong>StartSpawner</strong>( Item spawner ) : 此方法在生成器携带生成组放置在世界中时调用，必须激活并生成。</li>
  </ol>
  <p>当您选择'其他'选项时，您将获得SpawnerHelper.cs中的骨架代码和默认RunUO生成器的注释代码，以便您了解如何编写您的特定实现。</p>
  <p>注意：我将在业余时间提供对自定义生成器的支持。您可以通过我的网站论坛联系我。如果您是生成器对象的作者，并希望Pandora's Box官方支持，请为您的生成器编写一个特定的SpawnerHelper类，并将脚本发送给我，地址为<a href="mailto:arya@box.it">arya@box.it</a></p>
  <p class="style1">8. 模块</p>
  <p>BoxServer由模块组成。您可以在安装向导中选择要安装的模块，如果您稍后想要移除模块，只需删除Modules目录中的相应文件夹并重新启动服务器即可。请不要从Core文件夹中删除任何文件，因为它们可能会破坏BoxServer。我不会为此类情况提供支持。 </p>
  <blockquote>
    <p class="style1">1. 核心</p>
    <p>顾名思义，核心模块包含用于BoxServer主要功能的类：</p>
  </blockquote>
  <ul>
    <li>登录功能：为Pandora's Box提供快速身份验证，以便在访问其他BoxServer功能之前允许访问。</li>
    <li>贯穿BoxServer脚本的各类数据结构。</li>
    <li>BoxServer脚本使用的各类方法。</li>
    <li>错误消息</li>
    <li>数据文件生成器：虽然放在单独的目录中便于识别，但这些脚本仍然是BoxServer的核心，不应移除（否则其他模块可能无法编译）。数据生成脚本可以通过BoxServer控制面板访问（请参阅游戏命令部分了解更多详细信息）。</li>
  </ul>
  <blockquote>
    <p>尝试修改核心功能是完全不支持的，因为这可能会破坏BoxServer的行为，Pandora's Box的行为，并可能对您的服务器构成安全威胁。</p>
    <p class="style1">2. 构建器</p>
    <p><strong>身份验证</strong>: IAuthenticable<br>
      <strong>MinAccessLevel</strong>: GameMaster<br>
      <strong>RequireOnlineMobile</strong>: true </p>
    <p>此模块用于Pandora's Box的多个功能（如屋顶和随机铺路器）。当您通过屋顶工具创建物品结构时，例如，使用生成通过服务器选项，结构将自动保存在Builder类中。这将允许Pandora's Box用户快速移动、移除或改变整个结构。</p>
    <p class="style1">3. 检索数据文件</p>
    <p><strong>身份验证</strong>: 基本 <br>
      <strong>MinAccessLevel</strong>: BoxServer默认 <br>
      <strong>RequireOnlineMobile</strong>: 无 (false)</p>
    <p>此模块允许用户检索Pandora's Box用于显示自定义物品、生物等的数据文件。可用的数据文件有：</p>
  </blockquote>

  <ul>
    <li>BoxData [ RunUO\TheBox\BoxData.xml ] : 包含服务器上所有可构造物品和生物的定义。</li>
    <li>PropsData [ RunUO\TheBox\PropsData.xml ] : 包含所有在可构造物品和生物上定义的属性的定义。它用于Pandora's Box的Props标签。</li>
    <li>SpawnData [ RunUO\TheBox\SpawnData.xml ] : 包含世界中生成信息，用于在Pandora's Box旅行地图上显示。</li>
  </ul>
<blockquote>
    <p>此模块对于向工作人员分发服务器特定信息非常有用。所有数据文件默认在RunUO\TheBox文件夹中生成。如果您希望用户仅检索部分可用数据文件（例如仅BoxData），只需不生成（或删除）RunUO\TheBox文件夹中的其他数据文件即可。</p>
    <p class="style1">4. 脚本浏览器</p>
    <p><strong>身份验证</strong>: 自定义 <br>
      <strong>MinAccessLevel</strong>: BoxServer默认 <br>
      <strong>RequireOnlineMobile</strong>: 无 (false)</p>
    <p>这是一个强大但潜在危险的模块。简单来说，它是一个FTP架构，仅限于.cs、.vb、.xml和.txt文件。它允许远程用户下载、上传、删除和移动文件，并旨在帮助远程脚本。</p>
    <p>为了最小化此模块的风险，需要一个特殊的配置，位于文件\Modules\ScriptExplorer\Configuration.cs中。您必须为该模块提供用户显式权限，方法是指定其账户名称和允许访问的文件夹。所有文件夹都相对于服务器上的\Scripts\文件夹指定。Configuration.cs文件详细说明了如何为该模块注册用户。</p>
    <p>每当用户尝试使用此模块时，脚本都会检查用户是否已注册，如果是，则检查文件是否属于用户注册的文件夹（s）。</p>
    <p>重要提示：此模块仅在服务器运行时激活。如果远程用户修改脚本，或上传无法编译的代码，然后重新启动服务器，服务器将不会重新启动，需要其他维护手段。请谨慎使用此模块。</p>
    <p class="style1">5. 生成组</p>
    <p><strong>身份验证</strong>: IAuthenticable <br>
      <strong>MinAccessLevel</strong>: GameMaster <br>
      <strong>RequireOnlineMobile</strong>: true</p>
  <p>此模块允许用户在Pandora's Box中生成完整的生成组。有关生成器的更多信息，请参阅第7节。</p>
    <p class="style1">6. 客户端列表</p>
    <p><strong>身份验证</strong>: 对客户端执行命令 <br>
        <strong>MinAccessLevel</strong>: GameMaster <br>
        <strong>RequireOnlineMobile</strong>: true 对客户端执行命令 </p>
  <p>此模块将客户端列表传输到Pandora's Box。收集的信息包括：玩家和账户名称、最后登录时间、位置、地图和序列。此模块用于Pandora's Box的客户端地图，用于显示客户端在世界地图上的位置，以及客户端列表，用于列出（允许不同排序）所有连接的客户端。第二种模式还允许快速转到选定的客户端，查看其属性或客户端信息，对于管理员还允许查看其账户详情。 </p>
  </blockquote>
  <p class="style1"><strong>9. 卸载</strong></p>
  <p>卸载BoxServer非常简单，分为三个步骤：</p>
  <ol>
    <li>删除文件 \RunUO\BoxServer.dll</li>
    <li>打开文件 \RunUO\Data\Assemblies.cfg 并移除以下条目：
      <ol>
        <li>BoxServer.dll</li>
        <li>System.Runtime.Remoting.dll（请记住，其他软件可能需要此项，例如UOArchitect或Orbsydia的其他程序）</li>
      </ol>
    </li>
    <li>删除BoxServer文件夹中的所有脚本。</li>
  </ol>
  <p class="style1"><strong>10. 支持</strong></p>
  <p>BoxServer的支持通过位于<a href="http://arya.runuo.com/" target="_blank">http://arya.runuo.com/</a>的BoxServer论坛提供 </p>
  <blockquote>
    <p>&nbsp;</p>
  </blockquote>
</body>
</html>
